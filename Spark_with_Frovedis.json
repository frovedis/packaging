{"paragraphs":[{"text":"%spark\nimport org.apache.spark.mllib.linalg.{Vector, Vectors}\nimport org.apache.spark.mllib.linalg.Matrix\nimport org.apache.spark.mllib.linalg.distributed.RowMatrix\nimport org.apache.spark.mllib.linalg.SingularValueDecomposition\nimport com.nec.frovedis.Jexrpc.FrovedisServer\nimport com.nec.frovedis.matrix.ARPACK\ndef createVector(line: String, size: Int) : Vector = {\n    val item = line.split(\" \")\n    val vlen = item.length\n    var data = Array.ofDim[Double](vlen)\n    var idx = Array.ofDim[Int](vlen)\n    for(i <- 0 until vlen) {\n      val idxdata = item(i).split(\":\")\n      idx(i) = idxdata(0).toInt\n      data(i) = idxdata(1).toDouble\n    }\n    Vectors.sparse(size, idx, data)\n}\n\nval size = 18162\nval vectors=sc.textFile(\"file://\" + sys.env(\"INSTALLPATH\") + \"/data/demo/ratings_matrix\",8).map(line=>createVector(line, size))\nval mat: RowMatrix = new RowMatrix(vectors)\n\nimport scala.io.Source\n\nval s = Source.fromFile(sys.env(\"INSTALLPATH\") + \"/data/demo/movielist\")\nval movielist = try s.getLines.toArray finally s.close","dateUpdated":"2018-06-17T22:01:11+0900","config":{"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","editorHide":false,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1529240471043_1599835101","id":"20171026-131305_1697270172","dateCreated":"2018-06-17T22:01:11+0900","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:174"},{"text":"%spark\n\nval k = 200\nFrovedisServer.initialize(\"mpirun -np 1 \" + sys.env(\"FROVEDIS_SERVER\"))\nval start = System.currentTimeMillis\nval ret = ARPACK.computeSVD(mat, k)\nval svd: SingularValueDecomposition[RowMatrix, Matrix] = ret.to_spark_result(sc)\nprintf(\"%%html\\n<h3> Spark with Frovedis: training time = %d sec</h3>\\n\", (System.currentTimeMillis - start)/1000)\nFrovedisServer.shut_down()\nval U: RowMatrix = svd.U\nval s: Vector = svd.s\nval V: Matrix = svd.V","dateUpdated":"2018-06-17T22:01:24+0900","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1529240471049_1595987612","id":"20171026-131233_1343713632","dateCreated":"2018-06-17T22:01:11+0900","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:175"},{"text":"%spark\n\nval userID = 5669\n//val userID = 135\nval alreadyRated = mat.rows.zipWithIndex.map{case (k,v) => (v,k)}.lookup(userID)(0).toSparse\nval ratedPair = alreadyRated.values.zip(alreadyRated.indices).sorted.reverse.take(5)\nprintf(\"\\n%%html\\n<table border=1 style=\\\"font-size: 12pt;\\\">\\n<tr><th>Movies highly rated by user (ID:%d)</th></tr>\",userID)\nratedPair.map(t => printf(\"<tr><td>%s</td></tr>\",movielist(t._2)))\nprintf(\"</table>\\n\")\nval ratedSet = alreadyRated.indices.toSet\nval userVec = U.rows.zipWithIndex.map{case (k,v) => (v,k)}.lookup(userID)(0).toDense\nval userVec_s = userVec.toArray.zip(s.toArray).map(i => i._1 * i._2)\nval toRecommend = V.multiply(Vectors.dense(userVec_s)).toArray.zipWithIndex.sorted.reverse.take(6+ratedSet.size).filterNot(t => ratedSet.contains(t._2)).take(5)\nprintln(\"<br><table border=1 style=\\\"font-size: 12pt;\\\">\\n<tr><th>Recommending movies</th><th>Evalation</th></tr>\")\ntoRecommend.map(t => printf(\"<tr><td>%s</td><td>%.3f</td></tr>\",movielist(t._2),t._1))\nprintf(\"</table>\\n\")","dateUpdated":"2018-06-17T22:01:11+0900","config":{"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","editorHide":false,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1529240471050_1597141859","id":"20171026-131249_569482956","dateCreated":"2018-06-17T22:01:11+0900","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:176"},{"text":"%spark\n","dateUpdated":"2018-06-17T22:01:11+0900","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1529240471050_1597141859","id":"20171026-131429_1643451280","dateCreated":"2018-06-17T22:01:11+0900","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:177"}],"name":"Spark with Frovedis","id":"2DF8APAUE","angularObjects":{"2DFEF3H5U:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}